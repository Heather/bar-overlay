--- a/uksm-0.1.2.1-for-v3.6.ge.2.patch	2012-12-19 10:15:21.836178899 +0000
+++ b/uksm-0.1.2.1-for-v3.6.ge.2.patch	2012-12-19 10:19:03.550407086 +0000
@@ -223,16 +223,16 @@
 index 2daa54f..64c6dba 100644
 --- a/include/linux/mmzone.h
 +++ b/include/linux/mmzone.h
-@@ -142,6 +142,9 @@ enum zone_stat_item {
+@@ -142,6 +142,9 @@
  	NUMA_OTHER,		/* allocation from other node */
  #endif
  	NR_ANON_TRANSPARENT_HUGEPAGES,
 +#ifdef CONFIG_UKSM
 +	NR_UKSM_ZERO_PAGES,
 +#endif
+ 	NR_FREE_CMA_PAGES,
  	NR_VM_ZONE_STAT_ITEMS };
  
- /*
 @@ -808,7 +811,7 @@ static inline int is_normal_idx(enum zone_type idx)
  }
  
@@ -502,13 +502,13 @@
 index 42d283e..8f86ff2 100644
 --- a/lib/Makefile
 +++ b/lib/Makefile
-@@ -8,7 +8,7 @@ KBUILD_CFLAGS = $(subst -pg,,$(ORIG_CFLAGS))
+@@ -8,7 +8,7 @@
  endif
  
  lib-y := ctype.o string.o vsprintf.o cmdline.o \
 -	 rbtree.o radix-tree.o dump_stack.o timerqueue.o\
 +	 rbtree.o radix-tree.o sradix-tree.o dump_stack.o timerqueue.o\
- 	 idr.o int_sqrt.o extable.o prio_tree.o \
+ 	 idr.o int_sqrt.o extable.o \
  	 sha1.o md5.o irq_regs.o reciprocal_div.o argv_split.o \
  	 proportions.o flex_proportions.o prio_heap.o ratelimit.o show_mem.o \
 diff --git a/lib/sradix-tree.c b/lib/sradix-tree.c
@@ -1342,10 +1342,10 @@
  	WARN_ON(mm->nr_ptes > (FIRST_USER_ADDRESS+PMD_SIZE-1)>>PMD_SHIFT);
  }
  
-@@ -2419,6 +2453,7 @@ struct vm_area_struct *copy_vma(struct vm_area_struct **vmap,
- 			if (new_vma->vm_ops && new_vma->vm_ops->open)
+@@ -2483,6 +2483,7 @@
  				new_vma->vm_ops->open(new_vma);
  			vma_link(mm, new_vma, prev, rb_link, rb_parent);
+ 			*need_rmap_locks = false;
 +			uksm_vma_add_new(new_vma);
  		}
  	}
